use std::error::Error;


const MAX_DNS_PACKET_SIZE : usize = 512;
const MAX_DNS_QNAME_SIZE : usize = 255;
const DNS_HEADER_SIZE : usize = 12;

#[tokio::main]
async fn main() -> Result<(), Box<dyn Error>> {
    use tokio::net::UdpSocket;

    // Build the DNS query packet
    let query: [u8; 32] = [
        0x12, 0x34,             // ID
        0x01, 0x00,             // Flags (standard query with recursion)
        0x00, 0x01,             // Questions: 1
        0x00, 0x00,             // Answer RRs: 0
        0x00, 0x00,             // Authority RRs: 0
        0x00, 0x00,             // Additional RRs: 0
        0x03, 0x77, 0x77, 0x77, // QNAME: "www"
        0x06, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, // "google"
        0x03, 0x63, 0x6f, 0x6d, // "com"
        0x00,                   // Null terminator for QNAME
        0x00, 0x01,             // QTYPE: 1 (A record)
        0x00, 0x01,             // QCLASS: 1 (IN - Internet)
    ];

    // Bind a UDP socket to a local address
    let socket = UdpSocket::bind("0.0.0.0:0").await?;

    // Connect the socket to a DNS server (e.g., Google's public DNS server)
    socket.connect("8.8.8.8:53").await?;

    // Send the DNS query
    socket.send(&query).await?;

    // Create a buffer to hold the response
    let mut buf = [0u8; 512]; // DNS packets can be up to 512 bytes
    let n = socket.recv(&mut buf).await?;

    // Print the raw DNS response
    println!("Received {} bytes", n);
    println!("DNS packet: {:?}", &buf[..n]);

    Ok(())
}

fn extract_dns_payload(buf: &[u8; MAX_DNS_PACKET_SIZE]) -> &[u8] {
    let mut i = DNS_HEADER_SIZE;

    while i < buf.len() && i < DNS_HEADER_SIZE + MAX_DNS_QNAME_SIZE {
        if buf[i] == 0 {
            // exclude null terminator
            return &buf[12..=i-1];
        }

        i += 1;
    }

    &[]
}

#[cfg(test)]
mod tests {

    use super::*;

    #[test]
    fn test_extract_dns_payload_happy_path() {
        let payload = extract_dns_payload(&TEST_QUERY);
        assert_eq!(QNAME[0..15], *payload);
    }

    #[test]
    fn test_extract_dns_payload_empty_buffer() {
        let empty_buffer: [u8; MAX_DNS_PACKET_SIZE] = [0; MAX_DNS_PACKET_SIZE];
        let payload = extract_dns_payload(&empty_buffer);
        assert!(payload.is_empty());
    }

    #[test]
    fn test_extract_dns_payload_no_null_terminator() {
        let no_null_buffer: [u8; MAX_DNS_PACKET_SIZE] = [1; MAX_DNS_PACKET_SIZE];
        let payload = extract_dns_payload(&no_null_buffer);
        assert!(payload.is_empty());
    }

    #[test]
    fn test_extract_dns_payload_too_large_size() {
        let mut too_large_buffer: [u8; MAX_DNS_PACKET_SIZE] = [1; MAX_DNS_PACKET_SIZE];
        too_large_buffer[too_large_buffer.len() - 1] = 0;
        let payload = extract_dns_payload(&too_large_buffer);
        assert!(payload.is_empty());
    }


    const TEST_QUERY: [u8; MAX_DNS_PACKET_SIZE] = [
        0x12, 0x34,             // ID
        0x01, 0x00,             // Flags (standard query with recursion)
        0x00, 0x01,             // Questions: 1
        0x00, 0x00,             // Answer RRs: 0
        0x00, 0x00,             // Authority RRs: 0
        0x00, 0x00,             // Additional RRs: 0
        0x03, 0x77, 0x77, 0x77, // QNAME: "www"
        0x06, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, // "google"
        0x03, 0x63, 0x6f, 0x6d, // "com"
        0x00,                   // Null terminator for QNAME
        0x00, 0x01,             // QTYPE: 1 (A record)
        0x00, 0x01,             // QCLASS: 1 (IN - Internet)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ];
    const QNAME: [u8; 16] = [
        0x03, 0x77, 0x77, 0x77, // QNAME: "www"
        0x06, 0x67, 0x6f, 0x6f, 0x67, 0x6c, 0x65, // "google"
        0x03, 0x63, 0x6f, 0x6d, // "com"
        0x00,                   // Null terminator for QNAME
    ];
}
